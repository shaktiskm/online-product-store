{"version":3,"sources":["../../../lib/endpoints/product/ProductService.es6"],"names":["ApiError","require","documentSchema","protectedService","ProductService","dbService","genericValidator","uniqueIdService","logger","_dbService","_logger","UniqueIdService","collection","req","res","next","query","read","then","info","successResponse","id","result","successHandler","catch","error","err","errorHandler","payload","schema","schemaValidation","body","uniqueId","createUniqueId","document","validateProductSchema","Object","assign","insertOne","Error","apiErr","productId","params","update","remove","qty","data","keys","length","reqId","status","send","getServiceInstance","module","exports"],"mappings":"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","file":"ProductService.js","sourcesContent":["const ApiError = require(\"../../util/apiError\"),\n  documentSchema = require(\"../../schemas/document\");\n\nlet protectedService;\n\nclass ProductService {\n\n  constructor(dbService, genericValidator, uniqueIdService, logger) {\n    this._dbService = dbService;\n    this._logger = logger;\n    ProductService.UniqueIdService = uniqueIdService;\n    ProductService.genericValidator = genericValidator;\n    ProductService.collection = \"products\";\n  }\n\n  static successHandler(data, res, next) {\n    if (!data || Object.keys(data).length === 0) {\n      return next(new ApiError(data.reqId, 404, \"Not Found\", \"Resource does not exist\", \"\"));\n    }\n    res.status(200).send(data);\n  }\n\n  static errorHandler(err, reqId, next) {\n    let apiErr = new ApiError(reqId, 500, \"Error\", \"Internal Server Error\", err);\n\n    next(apiErr);\n  }\n\n  retrieveProducts(req, res, next) {\n    let collection = ProductService.collection,\n      query = {\n        \"body\": {}\n      };\n\n    this._dbService\n      .read({collection, query})\n      .then(result => {\n        this._logger.info(\"retrieveProducts()//Successfully retrieved products\");\n        let successResponse = {\n          \"reqId\": req.id,\n          \"status\": \"success\",\n          \"data\": result\n        };\n\n        ProductService.successHandler(successResponse, res, next);\n      })\n      .catch(err => {\n        this._logger.error(\"retrieveProducts()//Error in retrieving products\", err);\n        ProductService.errorHandler(err, req.id, next);\n      });\n  }\n\n  validateProductSchema(payload, schema) {\n    return ProductService.genericValidator.schemaValidation(payload, schema);\n  }\n\n  createProduct(req, res, next) {\n    let collection = ProductService.collection,\n      payload = req.body,\n      uniqueId = ProductService.UniqueIdService.createUniqueId(),\n      document;\n\n    try {\n      if (this.validateProductSchema(payload, documentSchema)) {\n\n        document = Object.assign(payload, {\"_id\": uniqueId});\n        this._dbService\n          .insertOne({collection, document})\n          .then(result => {\n            let successResponse = {\n              \"reqId\": req.id,\n              \"id\": uniqueId,\n              \"status\": \"success\"\n            };\n\n            if (result && result === 1) {\n              this._logger.info(\"createProduct()//Successfully created product in database\");\n              ProductService.successHandler(successResponse, res, next);\n            } else {\n              this._logger.info(\"createProduct()//Error in creating product\");\n              ProductService.errorHandler(new Error(\"DBError\"), req.id, next);\n            }\n          })\n          .catch(err => {\n            this._logger.error(\"createProduct()//Error in creating product\", err);\n            ProductService.errorHandler(err, req.id, next);\n          });\n      }\n    } catch (err) {\n      let apiErr = new ApiError(req.id, 400, \"ValidationError\", \"Bad Request\", err);\n\n      this._logger.error(\"createProduct()//Error in validating schema ...\", err);\n      return next(apiErr);\n    }\n  }\n\n  retrieveProductById(req, res, next) {\n    let collection = ProductService.collection,\n      productId = req.params.id,\n      query = {\n        \"body\": {\n          \"_id\": productId\n        }\n      };\n\n    this._dbService\n      .read({collection, query})\n      .then(result => {\n        this._logger.info(`retrieveProductById()//Successfully retrieved product with id ${productId}`, result);\n        let successResponse = {\n          \"reqId\": req.id,\n          \"status\": \"success\",\n          \"data\": result\n        };\n\n        ProductService.successHandler(successResponse, res, next);\n      })\n      .catch(err => {\n        this._logger.error(\"retrieveProductById()//Error in retrieving product\", err);\n        ProductService.errorHandler(err, req.id, next);\n      });\n  }\n\n  updateProductById(req, res, next) {\n    let collection = ProductService.collection,\n      productId = req.params.id,\n      payload = req.body,\n      query = {\n        \"_id\": productId\n      },\n      document = {\n        \"$set\": payload\n      };\n\n    try {\n      if (this.validateProductSchema(payload, documentSchema)) {\n        this._dbService\n          .update({collection, query, document})\n          .then(result => {\n            let successResponse = {\n              \"reqId\": req.id,\n              \"id\": productId,\n              \"status\": \"success\"\n            };\n\n            if (!result || result === 0) {\n              let apiErr = new ApiError(req.id, 404, \"NotFound\", \"Resource doesn't exist\", \"\");\n\n              return next(apiErr);\n            }\n            this._logger.info(`updateProductById()//Successfully updated product of id ${productId}`);\n\n            ProductService.successHandler(successResponse, res, next);\n          })\n          .catch(err => {\n            this._logger.error(\"updateProductById()//Error in updating product\", err);\n            ProductService.errorHandler(err, req.id, next);\n          });\n      }\n    } catch (err) {\n      let apiErr = new ApiError(req.id, 400, \"ValidationError\", \"Bad Request\", err);\n\n      this._logger.error(\"updateProductById()//Error in validating schema ...\", err);\n      return next(apiErr);\n    }\n  }\n\n  deleteProductById(req, res, next) {\n    let collection = ProductService.collection,\n      productId = req.params.id,\n      document = {\n        \"_id\": productId\n      };\n\n    this._dbService\n      .remove({collection, document})\n      .then(result => {\n        let successResponse = {\n          \"reqId\": req.id,\n          \"id\": productId,\n          \"status\": \"success\"\n        };\n\n        if (!result || result === 0) {\n          let apiErr = new ApiError(req.id, 404, \"NotFound\", \"Resource doesn't exist\", \"\");\n\n          return next(apiErr);\n        }\n        this._logger.info(`deleteProductById()//Successfully removed product of id ${productId}`);\n\n        ProductService.successHandler(successResponse, res, next);\n      })\n      .catch(err => {\n        this._logger.error(\"deleteProductById()//Error in removing product\", err);\n        ProductService.errorHandler(err, req.id, next);\n      });\n\n  }\n\n  addOrRemoveProductQty(req, res, next) {\n    let collection = ProductService.collection,\n      productId = req.params.id,\n      payload = req.body,\n      query = {\n        \"_id\": productId\n      },\n      document = {\n        \"$inc\": {\n          \"qty\": payload.qty\n        }\n      };\n\n    this._dbService\n      .update({collection, query, document})\n      .then(result => {\n        let successResponse = {\n          \"reqId\": req.id,\n          \"id\": productId,\n          \"status\": \"success\"\n        };\n\n        if (!result || result === 0) {\n          let apiErr = new ApiError(req.id, 404, \"NotFound\", \"Resource doesn't exist\", \"\");\n\n          return next(apiErr);\n        }\n        this._logger.info(`addOrRemoveProductQty()//Successfully updated product quantity of id ${productId}`);\n\n        ProductService.successHandler(successResponse, res, next);\n      })\n      .catch(err => {\n        this._logger.error(\"addOrRemoveProductQty()//Error in updating product quantity\", err);\n        ProductService.errorHandler(err, req.id, next);\n      });\n  }\n\n}\n\n\nfunction getServiceInstance(dbService, genericValidator, uniqueIdService, logger) {\n  protectedService = protectedService || new ProductService(dbService, genericValidator, uniqueIdService, logger);\n  return protectedService;\n}\n\nmodule.exports = exports = getServiceInstance;\nexports.ProductService = ProductService;\n"]}