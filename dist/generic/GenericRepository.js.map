{"version":3,"sources":["../../lib/generic/GenericRepository.es6"],"names":["require","MongoClient","Q","protectedGenericRepoIns","GenericRepository","config","logger","mongoDb","connectionString","Error","connectionString_","connectionOptions_","connectionOptions","operationTimeout_","operationTimeout","commonWriteConcern_","promiseTimeout_","promiseTimeout","dbConnection_","connectToDB","info","ninvoke","timeout","catch","error","err","then","dbConn","query","fields","limit","skip","sort","collection","options","push","body","readQuery","getMongoDBObject","npost","db","cursor","results","pipeline","document","writeResult","result","n","getGenericRepoIns","module","exports"],"mappings":"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","file":"GenericRepository.js","sourcesContent":["const {MongoClient} = require(\"mongodb\"),\n  Q = require(\"q\");\n\nlet protectedGenericRepoIns;\n\nclass GenericRepository {\n\n  constructor(config, logger) {\n    if (!config || !config.mongoDb.connectionString) {\n      throw new Error(\"MongoDB connection string not available\");\n    }\n\n    /** @member {Object} logger object */\n    this.logger = logger;\n\n    /** @member {string} Connection string to database. */\n    this.connectionString_ = config.mongoDb.connectionString;\n\n    /** @member {Object} Options object to pass to the driver connect method. */\n    this.connectionOptions_ = config.mongoDb.connectionOptions;\n\n    /** @member {string} Operation timeout in ms. */\n    this.operationTimeout_ = config.mongoDb.operationTimeout;\n\n    /** @member {Object} The default write concern for CUD operations. */\n    this.commonWriteConcern_ = {\n      \"wtimeout\": config.mongoDb.operationTimeout,\n      \"j\": true,\n      \"w\": \"majority\"\n    };\n\n    /** @member {number} The default timeout for promises in ms */\n    this.promiseTimeout_ = config.mongoDb.promiseTimeout;\n\n    /** @member {Q.Promise} Promise which represents the db connection and resolves to the db controller object. */\n    this.dbConnection_ = this.connectToDB();\n  }\n\n  /**\n   * Create connection to the mongodb database.\n   * @private\n   * @returns {Q.Promise} A promise which resolves the connection to the mongodb client.\n   */\n  connectToDB() {\n    this.logger.info(\"Connecting to db with options: \", this.connectionString_);\n    this.dbConnection_ = Q.ninvoke(MongoClient, \"connect\", this.connectionString_, this.connectionOptions_);\n    return this.dbConnection_;\n  }\n\n  /**\n   * function for creating the mongodb object.\n   * @returns {object} mongodb object after creating the connection.\n   */\n  getMongoDBObject() {\n\n    return this.dbConnection_\n      .timeout(this.promiseTimeout_)\n      .catch(err => {\n        this.logger.error(\" MongoDB connection is not available\", err);\n        return this.connectToDB();\n      })\n      .then(dbConn => {\n        return dbConn;\n      });\n  }\n\n  /**\n   *@param {object} query read query\n   *@returns {object} returns promise for read query\n   */\n  readQuery(query) {\n\n    return {\n      \"fields\": query.fields || {},\n      \"limit\": query.limit || 0,\n      \"skip\": query.skip || 0,\n      \"sort\": query.sort || {}\n    };\n  }\n\n  /**\n   *@param {string} collection collection to be used for query\n   *@param {object} query query object which contains body(filter query), fields, limit, skip, sort fields\n   *@returns {Q.Promise} returns promise for read query\n   */\n  read({collection, query}) {\n\n    let options = [];\n\n    options.push(query.body);\n    options.push(this.readQuery(query));\n\n    return this.getMongoDBObject()\n      .then(db => {\n        return Q.npost(\n          db.collection(collection), \"find\", options\n        )\n          .timeout(this.promiseTimeout_)\n          .then(cursor => {\n            return Q.ninvoke(cursor, \"toArray\"\n            )\n              .then(results => {\n                return results;\n              });\n          });\n      });\n  }\n\n  /**\n   *@param {string} collection collection to be used for query\n   *@param {object} pipeline pipeline to be used in aggregation\n   *@returns {Q.Promise} returns promise for aggregation\n   */\n  aggregate({collection, pipeline}) {\n\n    return this.getMongoDBObject()\n      .then(db => {\n        return Q.ninvoke(\n          db.collection(collection),\n          \"aggregate\",\n          pipeline\n        );\n      });\n  }\n\n  /**\n   *\n   * @param {string} collection name.\n   * @param {object} object to be inserted into the collections\n   * @returns {Q.Promise} returns promise for insertion\n   */\n\n  insertOne({collection, document}) {\n    return this.getMongoDBObject()\n      .then(db => {\n        return Q.ninvoke(db.collection(collection), \"insertOne\", document, this.commonWriteConcern_);\n      })\n      .timeout(this.promiseTimeout_)\n      .then(writeResult => {\n\n        if (writeResult.result.n === 0) {\n          let err = new Error(\"Nothing is inserted in db\");\n\n          this.logger.error(\"Nothing is inserted in db when trying to create entity: \", document);\n          throw err;\n        }\n\n        return writeResult.result.n;\n      });\n  }\n\n  update({collection, query, document}) {\n    return this.getMongoDBObject()\n      .then(db => {\n        return Q.ninvoke(db.collection(collection), \"updateOne\", query, document, this.commonWriteConcern_);\n      })\n      .timeout(this.promiseTimeout_)\n      .then(writeResult => {\n\n        if (writeResult.result.n === 0) {\n          this.logger.error(\"Nothing is updated in db when trying to update document: \", document);\n        }\n\n        return writeResult.result.n;\n      });\n  }\n\n  remove({collection, document}) {\n    return this.getMongoDBObject()\n      .then(db => {\n        return Q.ninvoke(db.collection(collection), \"deleteOne\", document, this.commonWriteConcern_);\n      })\n      .timeout(this.promiseTimeout_)\n      .then(writeResult => {\n\n        if (writeResult.result.n === 0) {\n          this.logger.error(\"Nothing is deleted from db when trying to delete document: \", document);\n        }\n\n        return writeResult.result.n;\n      });\n  }\n}\n\nfunction getGenericRepoIns(config, logger) {\n  protectedGenericRepoIns = protectedGenericRepoIns || new GenericRepository(config, logger);\n  return protectedGenericRepoIns;\n}\n\nmodule.exports = exports = getGenericRepoIns;\nexports.GenericRepository = GenericRepository;\n"]}